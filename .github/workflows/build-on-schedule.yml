name: Build props (on schedule)

on:
  schedule:
    - cron: "37 13 7 * *" # At 13:37 on day-of-month 7. (UTC)

jobs:
  build:
    name: Build props
    strategy:
      matrix:
        # Devices to build props for
        device_name: [cheetah, raven, redfin]

    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install APT packages
        uses: daaku/gh-action-apt-install@v4
        with:
          packages: dos2unix python3 python3-pip

      - name: Install protobuf
        run: |
          pip install --upgrade pip
          pip3 install -Iv protobuf==3.20.3

      - name: Make all scripts executable
        run: chmod +x *.sh

      - name: Download latest OTA build for ${{ matrix.device_name }}
        run: ./download_latest_ota_build.sh ${{ matrix.device_name }}

      - name: Extract images and build props
        run: ./extract_images.sh

      - name: Prepare for upload
        run: |
          mkdir -p result
          cp ./**/**/{system,module}.prop result/

      - name: Upload artifacts
        # TODO: This step is temporary
        # check device prop repo
        # make update/release that repo
        # using action `softprops/action-gh-release`.
        uses: actions/upload-artifact@v3
        with:
          name: system-module-${{ matrix.device_name }}.prop
          path: result
          if-no-files-found: error
